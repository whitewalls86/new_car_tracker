{
  "name": "Vehicle Refresh",
  "nodes": [
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        0,
        0
      ],
      "id": "6f3726fc-0c64-46d0-97ba-da38c0771eac",
      "name": "On Completed Results Processing"
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "TRUNCATE TABLE vehicles;",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        208,
        0
      ],
      "id": "8fa7ffc4-80cc-45a6-b713-5285123b8a10",
      "name": "Truncate Vehicles",
      "credentials": {
        "postgres": {
          "id": "l8Ecbn62FzXCDkF9",
          "name": "Postgres account"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "-- Truncate-first rebuild of public.vehicles\n-- Behavior:\n--   - SRP drives listing/dealer/search metadata (current_listing_id, seller_customer_id, last_seen_*, etc.)\n--   - Newest price wins across: SRP + detail_primary + detail_carousel (via public.srp_listing_to_vin)\n--   - Full-details freshness is the newest of: SRP presence vs detail_primary parse\n--     (so SRP can keep full_details_last_updated_at from being NULL for most VINs)\n\nTRUNCATE TABLE public.vehicles;\n\nWITH\n/* ------------------------------------------------------------\n   1) SRP observations enriched with artifact metadata\n------------------------------------------------------------- */\nsrp_enriched AS (\n  SELECT\n    so.*,\n    ra.search_key,\n    ra.search_scope,\n    ra.run_id     AS artifact_run_id,\n    ra.fetched_at AS artifact_fetched_at\n  FROM public.srp_observations so\n  JOIN public.raw_artifacts ra\n    ON ra.artifact_id = so.artifact_id\n),\n\n/* ------------------------------------------------------------\n   2) Canonical SRP row per VIN (latest SRP presence)\n------------------------------------------------------------- */\nsrp_latest AS (\n  SELECT DISTINCT ON (vin)\n    vin,\n    listing_id,\n    canonical_detail_url,\n    year,\n    make,\n    model,\n    \"trim\",\n    stock_type,\n    fuel_type,\n    body_style,\n    financing_type,\n    price          AS srp_price,\n    msrp,\n    mileage,\n    seller_customer_id,\n    seller_zip,\n    trid,\n    isa_context,\n    raw_vehicle_json,\n\n    COALESCE(fetched_at, artifact_fetched_at) AS last_seen_at,\n    artifact_id                               AS last_seen_artifact_id,\n    COALESCE(run_id, artifact_run_id)         AS last_seen_run_id,\n    search_key                                AS last_seen_search_key,\n    search_scope                              AS last_seen_search_scope,\n    page_number                               AS last_seen_page_number,\n    position_on_page                          AS last_seen_position_on_page\n  FROM srp_enriched\n  WHERE vin IS NOT NULL\n    AND length(vin) = 17\n  ORDER BY\n    vin,\n    COALESCE(fetched_at, artifact_fetched_at) DESC,\n    artifact_id DESC\n),\n\n/* ------------------------------------------------------------\n   3) First-seen timestamp per VIN (from SRP timeline)\n------------------------------------------------------------- */\nsrp_first_seen AS (\n  SELECT\n    vin,\n    MIN(COALESCE(fetched_at, artifact_fetched_at)) AS first_seen_at\n  FROM srp_enriched\n  WHERE vin IS NOT NULL\n    AND length(vin) = 17\n  GROUP BY vin\n),\n\n/* ------------------------------------------------------------\n   4) All price events from all sources\n------------------------------------------------------------- */\nprice_events AS (\n  -- SRP\n  SELECT\n    vin,\n    fetched_at AS observed_at,\n    price,\n    artifact_id,\n    'srp'::text AS source\n  FROM public.srp_observations\n  WHERE vin IS NOT NULL\n    AND length(vin) = 17\n    AND price IS NOT NULL\n    AND price > 0\n\n  UNION ALL\n\n  -- Detail primary\n  SELECT\n    vin,\n    fetched_at AS observed_at,\n    price,\n    artifact_id,\n    'detail_primary'::text AS source\n  FROM public.detail_observations\n  WHERE vin IS NOT NULL\n    AND length(vin) = 17\n    AND price IS NOT NULL\n    AND price > 0\n\n  UNION ALL\n\n  -- Detail carousel (via SRP listingâ†’VIN map)\n  SELECT\n    m.vin,\n    h.fetched_at AS observed_at,\n    h.price,\n    h.artifact_id,\n    'detail_carousel'::text AS source\n  FROM public.detail_carousel_hints h\n  JOIN public.srp_listing_to_vin m\n    ON m.listing_id = h.listing_id\n  WHERE h.price IS NOT NULL\n    AND h.price > 0\n),\n\n/* ------------------------------------------------------------\n   5) Newest price per VIN (across all sources)\n------------------------------------------------------------- */\nlatest_price AS (\n  SELECT DISTINCT ON (vin)\n    vin,\n    observed_at AS price_last_seen_at,\n    source      AS price_last_seen_source,\n    price,\n    artifact_id AS price_last_artifact_id\n  FROM price_events\n  ORDER BY\n    vin,\n    observed_at DESC,\n    artifact_id DESC\n),\n\n/* ------------------------------------------------------------\n   6) Full-details freshness events:\n      - SRP presence counts as \"full details updated\" baseline (source='srp')\n      - Detail parse counts as full details updated (source='detail_primary')\n------------------------------------------------------------- */\nfull_detail_events AS (\n  -- SRP baseline\n  SELECT\n    se.vin,\n    se.last_seen_at AS observed_at,\n    se.last_seen_artifact_id AS artifact_id,\n    'srp'::text AS source\n  FROM srp_latest se\n\n  UNION ALL\n\n  -- Detail primary\n  SELECT\n    d.vin,\n    d.fetched_at AS observed_at,\n    d.artifact_id AS artifact_id,\n    'detail_primary'::text AS source\n  FROM public.detail_observations d\n  WHERE d.vin IS NOT NULL\n    AND length(d.vin) = 17\n),\n\nlatest_full_detail AS (\n  SELECT DISTINCT ON (vin)\n    vin,\n    observed_at AS full_details_last_updated_at,\n    source      AS full_details_last_updated_source,\n    artifact_id AS full_details_last_artifact_id\n  FROM full_detail_events\n  ORDER BY\n    vin,\n    observed_at DESC,\n    artifact_id DESC\n)\n\nINSERT INTO public.vehicles (\n  vin,\n  current_listing_id,\n  canonical_detail_url,\n\n  year,\n  make,\n  model,\n  \"trim\",\n  stock_type,\n  fuel_type,\n  body_style,\n  financing_type,\n\n  price,\n  msrp,\n  mileage,\n  price_is_valid,\n\n  seller_customer_id,\n  seller_zip,\n  trid,\n  isa_context,\n  raw_vehicle_json,\n\n  first_seen_at,\n  last_seen_at,\n\n  last_seen_artifact_id,\n  last_seen_run_id,\n  last_seen_search_key,\n  last_seen_search_scope,\n  last_seen_page_number,\n  last_seen_position_on_page,\n\n  price_last_seen_at,\n  price_last_seen_source,\n  price_last_artifact_id,\n\n  full_details_last_updated_at,\n  full_details_last_updated_source,\n  full_details_last_artifact_id,\n\n  updated_at\n)\nSELECT\n  s.vin,\n  s.listing_id,\n  s.canonical_detail_url,\n\n  s.year,\n  s.make,\n  s.model,\n  s.\"trim\",\n  s.stock_type,\n  s.fuel_type,\n  s.body_style,\n  s.financing_type,\n\n  lp.price,\n  s.msrp,\n  s.mileage,\n  (lp.price IS NOT NULL),\n\n  s.seller_customer_id,\n  s.seller_zip,\n  s.trid,\n  s.isa_context,\n  s.raw_vehicle_json,\n\n  fs.first_seen_at,\n  s.last_seen_at,\n\n  s.last_seen_artifact_id,\n  s.last_seen_run_id,\n  s.last_seen_search_key,\n  s.last_seen_search_scope,\n  s.last_seen_page_number,\n  s.last_seen_position_on_page,\n\n  lp.price_last_seen_at,\n  lp.price_last_seen_source,\n  lp.price_last_artifact_id,\n\n  fd.full_details_last_updated_at,\n  fd.full_details_last_updated_source,\n  fd.full_details_last_artifact_id,\n\n  now()\nFROM srp_latest s\nJOIN srp_first_seen fs\n  ON fs.vin = s.vin\nLEFT JOIN latest_price lp\n  ON lp.vin = s.vin\nLEFT JOIN latest_full_detail fd\n  ON fd.vin = s.vin;\n",
        "options": {}
      },
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.6,
      "position": [
        416,
        0
      ],
      "id": "02511927-1ded-4e47-9521-1139fa5bce27",
      "name": "Rebuild Vehicles",
      "credentials": {
        "postgres": {
          "id": "l8Ecbn62FzXCDkF9",
          "name": "Postgres account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "On Completed Results Processing": {
      "main": [
        [
          {
            "node": "Truncate Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Truncate Vehicles": {
      "main": [
        [
          {
            "node": "Rebuild Vehicles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rebuild Vehicles": {
      "main": [
        []
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "fd467e9c-611e-4a03-9917-fb5a3205ebf2",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6819133d7d7a8c3c6c728508316cdaac6420c5bbe2de9a1439bbb952efe61179"
  },
  "id": "Zqzriv9Kmv8h2OlKOksJI",
  "tags": []
}